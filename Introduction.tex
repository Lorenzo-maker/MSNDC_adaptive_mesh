\section*{INTRODUCTION}

Over the last three decades, direct collocation methods have become popular for the numerical solution of nonlinear optimal control problems, see e.g.,~\cite{Fahroo:JGCD:2002,Elnager:TAC:1995,Fahroo:JAS:2000,Gong:AAS:2006}, to mention but a few. In direct collocation methods, state and control functions are discretized at a set of appropriately chosen points in the time horizon considered. Then, the continuous time optimal control problem (OCP) is \emph{transcribed} to a finite-dimensional nonlinear program (NLP), and the NLP is coded and solved using different available software packages, such as~\cite{casadi:MPC:2019, Rao:TMS:2010,GPOPSII:TMS:2013}, typically interfaced with Interior-Point~\cite{Biegler:CCE:2009} or SQP~\cite{SNOPT:SIAMReview:2005} back-end solvers.

A rich variety of approaches has been proposed to obtain highly accurate solutions. A na\"{i}ve approach would be to resort to the use of high-resolution (dense) discretization grids, with a requirement of a large amount of CPU and memory resources, especially if the resulting NLP is not sparse. Solutions to reduce the computational burden associated to uniform grid discretizations have been proposed in~\cite{Betts:JCAM:2000}, where new grid points are introduced by solving an integer programming problem that minimizes the
maximum discretization error by subdividing the current grid. In~\cite{Ross:AAS:2003}, the pseudospectral knotting method, initially proposed in~\cite{Fahroo:ASC:2000}, has been generalized by exchanging information across the patches in the form of event conditions associated with the optimal control problem. In~\cite{Gong:AAS:2006}, the user specifies the number of nodes to be increased within a particular phase, in case the error of the computed optimal control between two successive iterations is
greater than a prescribed threshold. Here, the
gradient of the control is employed to determine the location of
the knots. In~\cite{Binder:CCE:2000} and~\cite{Binder:TechRep:2000}, a wavelet-Galerkin approach is used to discretize the OCP into an NLP and a local error analysis of the states and a wavelet analysis of the
control profile decides whether to add or remove wavelet basis functions. When state and control path constraints are present, \cite{Schlegel:CCE:2005}  uses wavelet analysis of the control profile to determine the
regions that require refinement.
With the specific objective to trade numerical accuracy for robustness and complexity for execution speed, multiresolution techniques have been proposed in \cite{Jain:CDC:2007,Jain:JGCD:2008} for application that are time-critical, such as onboard real-time guidance and during emergency maneuvers.

Recently, a great deal of research effort has been devoted to the class of Gauss quadrature orthogonal collocation methods~\cite{Elnager:TAC:1995,Fahroo:JGCD:2002,Garg:Automatica:2010,Darby:JSR:2011,Darby:OCAM:2011}. In these approaches, the state is typically approximated using a Lagrange polynomial where the support points are chosen as Gauss quadrature points. The most advanced employ either Gauss-Legendre, Gauss-Radau or Gauss-Lobatto points~\cite{Biegler:book:2010}. Gauss quadrature collocation methods have been originally implemented as $p$ methods with a single interval for the whole time horizon. Convergence of these methods was achieved by increasing the degree of the approximating polynomial. Their converge rate is exponential for problems with smooth and well-behaved solutions~\cite{Canuto:book:1988,Fornberg:book:1996}. On the contrary, $h$ methods, where convergence is sought by increasing the number of mesh intervals, work well for problems whose solutions are non smooth, since even a low-order polynomial approximation can capture \emph{wild} solution behaviors on an extremely fine mesh. However, their converge rate is slow for problems with smooth solutions as compared to $p$ methods.

With the goal of getting the best of both worlds, $hp$ methods have been developed. Originally they were introduced for solving PDEs~\cite{Babuska:CMAME:1990}, while more recently they have been applied to OCPs as well~\cite{Darby:OCAM:2011,Darby:JSR:2011}. However, these approaches have demonstrated to create a great deal of noise in the error estimate, thereby making them computationally intractable when high-accuracy solutions are desired. Furthermore, the error estimate defined for these methods does not take advantage of the exponential convergence rate of a Gaussian quadrature collocation method.
Monitoring the error only in the state vector, Patterson et al.~\cite{Patterson:OCAM:2015} proposed a new $ph$-mesh refinement method that is very computationally efficient, does not suffer from noisy error estimates in~\cite{Darby:JSR:2011}, and produces larger mesh intervals for a given accuracy tolerance when compared with traditional fixed-order $h$ methods.

Motivated by the relative simple ideas behind~\cite{Patterson:OCAM:2015}, in this paper we present an automatic procedure to enhance the accuracy of the numerical solution of an OCP discretized via direct collocation at Gauss-Legendre points. First, a numerical solution is obtained by solving the associated NLP with an initial uniform discretization. Then, the method evaluates its accuracy and adaptively changes both the degree of the approximating polynomial within each mesh interval and the number of mesh intervals until a prescribed accuracy is met, thus following the ph strategy proposed in~\cite{Patterson:OCAM:2015}.
The number of mesh intervals is increased concurrently for all state vector components, in a classical fashion. Instead, generalizing the procedure in~\cite{Patterson:OCAM:2015}, we present an algorithm that allows the degree of the approximating polynomial to assume distinct values for each state vector component and for each finite element. To the best of the authors' knowledge, in the research works found in literature, the degree is always raised to the highest order for all the state components, with an associated waste of computational resources and no practical accuracy benefit.
		
The procedure presented unfolds in two main steps: (i) component-wise state error estimates are computed based on the difference between the Lagrange polynomial approximation and a higher-order estimate obtained by quadrature of the dynamics at Gauss-Legendre points within each finite element; then, (ii) the derived error estimates are employed to establish whether (a) the degree of the approximating polynomial should be increased or (b) the mesh interval should be split into subintervals. Option (a) is selected if the degree suggested by the method remains below a given threshold for all state components. Otherwise, according to option (b), a finer mesh is created in those intervals where excessive error is registered.
The NLP problem is solved again with the enhanced mesh and the evaluation procedure described is repeated. The process stops when, with the refined mesh and/or updated degrees, the NLP solution meets the prescribed error tolerance from the outset.

To validate the proposed procedure, we analyze its numerical results on three OCP problems. The mesh refinement outcomes highlight that, given a maximum error threshold, by allowing to increase the degree of the approximating polynomial independently for each state, our method effectively chooses to raise them frugally, thus reducing the overall number of NLP variables needed with clear benefits in terms of reduced CPU time, memory usage and reduced risk of being trapped in local minima.

